@model List<User>

@{
    ViewBag.Title = "Gestion utilisateurs";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<h2>Gestion Utilisateurs</h2>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Model)
        {
            <tr>
                <td class="id">@user.User_Id</td>
                <td data-field-name="Username" class="editable save">@user.Username</td>
                <td data-field-name="Email" class="editable save">@user.Email</td>
                <td class="editable">
                    <select class="role-dropdown" disabled>
                        @foreach (var role in ViewBag.Roles)
                        {cc2
                            <!option value="@role" @(role == user.Role ? "selected='selected'" : "")>@role</!option>
                        }
                    </select>
                </td>
                <td>
                    <button class="edit-button" data-user-id="@user.User_Id">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="confirm-button" style="display: none;">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="delete-button">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="cancel-button" style="display: none;">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Stockage des valeurs initiales des champs éditables et du dropdown
        var initialValues = {};
        var initialRoleValue = {};

        $(".edit-button").click(function () {
            // Recupere la ligne tr plus proche
            var $row = $(this).closest("tr");
            var userId = $row.find(".id").text();

            // Vérifier si les valeurs initiales pour cet utilisateur existent déjà
            if (!initialValues[userId]) {
                initialValues[userId] = {};
            }

            // Stocker les valeurs initiales avant l'édition
            $row.find(".save").each(function () {
                var fieldName = $(this).data("field-name");
                initialValues[userId][fieldName] = $(this).text();
            });

            // Stocker la valeur initiale du dropdown
            initialRoleValue[userId] = $row.find(".role-dropdown").val();

            // Activer l'édition des champs et du dropdown
            $row.find(".editable").attr("contenteditable", "true");
            $row.find(".role-dropdown").prop("disabled", false);

            // Cacher le bouton d'édition
            $(this).hide();

            // Afficher les boutons de confirmation et d'annulation
            $row.find(".confirm-button").show();
            $row.find(".cancel-button").show();

            // Cacher le bouton de suppression
            $row.find(".delete-button").hide();
        });

        $(".cancel-button").click(function () {

            //Recupere la ligne tr plus proche
            var $row = $(this).closest("tr");
            var userId = $row.find(".id").text();

            // Remet les valeur d'origine
            $row.find(".save").each(function () {
                var fieldName = $(this).data("field-name");
                $(this).text(initialValues[userId][fieldName]);
            });

            // Remet le drop down menu a sa valeur d'origine
            $row.find(".role-dropdown").val(initialRoleValue[userId]);

            // Désactive l'édition
            $row.find(".editable").removeAttr("contenteditable");
            $row.find(".role-dropdown").prop("disabled", true);
            $(this).hide();
            $row.find(".confirm-button").hide();
            $row.find(".edit-button").show();
            $row.find(".delete-button").show();
        });

        $(".confirm-button").click(function () {

            var $row = $(this).closest("tr");  //Recupere la ligne tr plus proche

            // Désactiver l'édition des champs et le dropdown
            $row.find(".editable").removeAttr("contenteditable"); 
            $row.find(".role-dropdown").prop("disabled", true);

            // Cacher les boutons confirm et cancel
            $(this).hide();
            $row.find(".cancel-button").hide();

            // Afficher les boutons Edit et delete
            $row.find(".edit-button").show();
            $row.find(".delete-button").show();
            
            // Créez un objet avec les données de l'utilisateur à mettre à jour
            var userData = {
                user_id: $row.find(".id").text(),
                username: $row.find("[data-field-name='Username']").text(),
                email: $row.find("[data-field-name='Email']").text(),
                role_name: $row.find(".role-dropdown").val()
            };

            // Envoyez les données à la méthode update_user via AJAX
            $.ajax({
                url: "http://127.0.0.1:5000/update_user",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(userData),
                error: function (xhr, status, error) {

                    // Gérer les erreurs
                    console.error(error);
                    alert("Une erreur s'est produite lors de la mise à jour de l'utilisateur. Les changements seront annulés.");

                    // Rollback des changements en revenant aux valeurs initiales
                    var userId = $row.find(".id").text();
                    $row.find("[data-field-name='Username']").text(initialValues[userId]["Username"]);
                    $row.find("[data-field-name='Email']").text(initialValues[userId]["Email"]);
                    $row.find(".role-dropdown").val(initialRoleValue[userId]);
                }
            });
        });
        $(".delete-button").click(function () {
            var $row = $(this).closest("tr");
            var userId = $row.find(".id").text();

            // Confirmation de suppression de l'utilisateur
            if (confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?")) {

                // Envoyer une requête DELETE au service REST pour supprimer l'utilisateur
                $.ajax({
                    url: "http://127.0.0.1:5000/delete_user",
                    type: "DELETE",
                    contentType: "application/json",
                    data: JSON.stringify({ user_id: userId }),
                    success: function (response) {
                        // Actualiser la page ou effectuer d'autres actions après la suppression réussie
                        alert("Utilisateur supprimé avec succès.");
                        window.location.reload(); // Recharger la page pour refléter les changements
                    },
                    error: function (xhr, status, error) {
                        // Gérer les erreurs de suppression
                        console.error(error);
                        alert("Une erreur s'est produite lors de la suppression de l'utilisateur.");
                    }
                });
            }
        });
    });
</script>